# Authentication API Documentation

## Base URL
```
http://localhost:3000/api/v1/auth
```

## Table of Contents
1. [Register User](#1-register-user)
2. [Login User](#2-login-user)
3. [Get Current User](#3-get-current-user)
4. [Change Password](#4-change-password)
5. [Logout User](#5-logout-user)

---

## 1. Register User

Register a new user account.

### Endpoint
```
POST /api/v1/auth/register
```

### Headers
```json
{
  "Content-Type": "application/json"
}
```

### Request Body
```json
{
  "name": "John Doe",
  "email": "john.doe@example.com",
  "password": "SecurePassword123!",
  "role": "SME_USER"
}
```

#### Body Parameters
| Parameter | Type   | Required | Description                                                                                    |
|-----------|--------|----------|------------------------------------------------------------------------------------------------|
| name      | string | Yes      | Full name of the user (2-100 characters)                                                       |
| email     | string | Yes      | Valid email address (must be unique in the system)                                             |
| password  | string | Yes      | Password (**minimum 8 characters required** - will be hashed automatically)                    |
| role      | string | No       | User role (default: "SME_USER" if not provided)                                                |

#### Valid Role Values
**IMPORTANT:** Only these exact values are accepted (case-sensitive):
- `ADMIN` - Administrator with full system access
- `AUDIT_PARTNER` - External auditor or audit partner role
- `SME_USER` - Small/Medium Enterprise user (default role)
- `VIEWER` - Read-only access user

> **Note for Frontend:**
> - The `id` field is auto-generated by the database, do NOT send it in the request
> - If `role` is not provided, it defaults to `SME_USER`
> - Email validation is performed on the server side
> - Password must be at least 8 characters (enforced by database)
> - The password is automatically hashed before storage using bcrypt

### Success Response
**Status Code:** `201 Created`

```json
{
  "success": true,
  "message": "User registered successfully. Please verify your email.",
  "data": {
    "user": {
      "id": 1,
      "name": "John Doe",
      "email": "john.doe@example.com",
      "role": "SME_USER",
      "isEmailVerified": false,
      "lastLogin": null,
      "createdAt": "2025-10-24T10:30:00.000Z",
      "updatedAt": "2025-10-24T10:30:00.000Z"
    }
  }
}
```

> **Note for Frontend:**
> - **NO TOKEN is returned on registration** - Token will be provided after email verification
> - The `id` is an auto-incremented integer (not UUID)
> - Password is NOT included in the response for security
> - `isEmailVerified` will be `false` initially
> - **Next Step:** Redirect user to email verification page where they will enter OTP
> - Once email is verified, the verification endpoint will return the token
> - **TODO:** Email verification endpoint will be added later (verify OTP â†’ get token)

### Error Responses

#### Email Already Exists
**Status Code:** `409 Conflict`
```json
{
  "success": false,
  "message": "Email already registered"
}
```

#### Validation Error
**Status Code:** `400 Bad Request`
```json
{
  "success": false,
  "message": "Validation error message"
}
```

---

## 2. Login User

Authenticate a user and receive a JWT token.

### Endpoint
```
POST /api/v1/auth/login
```

### Headers
```json
{
  "Content-Type": "application/json"
}
```

### Request Body
```json
{
  "email": "john.doe@example.com",
  "password": "SecurePassword123!"
}
```

#### Body Parameters
| Parameter | Type   | Required | Description                                      |
|-----------|--------|----------|--------------------------------------------------|
| email     | string | Yes      | User's registered email address                  |
| password  | string | Yes      | User's password (plain text, will be verified)   |

> **Note for Frontend:**
> - Both email and password are required
> - Password is sent as plain text but compared with hashed version on server
> - Connection should always use HTTPS in production
> - Rate limiting applies to login attempts for security
> - On successful login, `lastLogin` timestamp is updated automatically

### Success Response
**Status Code:** `200 OK`

```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": {
      "id": 1,
      "name": "John Doe",
      "email": "john.doe@example.com",
      "role": "SME_USER",
      "isEmailVerified": false,
      "lastLogin": "2025-10-24T10:35:00.000Z",
      "createdAt": "2025-10-24T10:30:00.000Z",
      "updatedAt": "2025-10-24T10:35:00.000Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

> **Note for Frontend:**
> - Store the `token` in localStorage/sessionStorage/cookies
> - Save user data in your state management (Redux, Context API, etc.)
> - The `lastLogin` field shows the current login time
> - Redirect to dashboard/home page after successful login
> - Handle "Remember Me" functionality on your side if needed

### Error Responses

#### Invalid Credentials
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Invalid email or password"
}
```

#### Missing Fields
**Status Code:** `400 Bad Request`
```json
{
  "success": false,
  "message": "Email and password are required"
}
```

---

## 3. Get Current User

Retrieve the authenticated user's profile information.

### Endpoint
```
GET /api/v1/auth/me
```

### Headers
```json
{
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Authentication
**Required:** Yes (JWT Token)

### Request Body
None

> **Note for Frontend:**
> - This is a **protected route** - requires JWT token in Authorization header
> - Header format: `Authorization: Bearer <your_token_here>`
> - Use this endpoint to verify if user session is still valid
> - Call this on app initialization to restore user session
> - Token must not be expired (check JWT expiry handling)

### Success Response
**Status Code:** `200 OK`

```json
{
  "success": true,
  "message": "User fetched successfully",
  "data": {
    "id": 1,
    "name": "John Doe",
    "email": "john.doe@example.com",
    "role": "SME_USER",
    "isEmailVerified": false,
    "lastLogin": "2025-10-24T10:35:00.000Z",
    "createdAt": "2025-10-24T10:30:00.000Z",
    "updatedAt": "2025-10-24T10:35:00.000Z"
  }
}
```

> **Note for Frontend:**
> - Password is never returned for security reasons
> - Use this data to update user profile in UI
> - If you get 401 error, token is invalid/expired - redirect to login
> - Consider caching this data to reduce API calls

### Error Responses

#### No Token Provided
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "No token provided"
}
```

#### Invalid Token
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "Invalid token"
}
```

#### Token Expired
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "Token expired"
}
```

#### User Not Found
**Status Code:** `404 Not Found`
```json
{
  "success": false,
  "message": "User not found"
}
```

---

## 4. Change Password

Change the password for the authenticated user.

### Endpoint
```
POST /api/v1/auth/change-password
```

### Headers
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Authentication
**Required:** Yes (JWT Token)

### Request Body
```json
{
  "oldPassword": "SecurePassword123!",
  "newPassword": "NewSecurePassword456!"
}
```

#### Body Parameters
| Parameter   | Type   | Required | Description                                         |
|-------------|--------|----------|-----------------------------------------------------|
| oldPassword | string | Yes      | Current password (for verification)                 |
| newPassword | string | Yes      | New password (**minimum 8 characters required**)    |

> **Note for Frontend:**
> - This is a **protected route** - requires JWT token
> - Both passwords are required
> - Old password must match the current password in database
> - New password must be at least 8 characters
> - New password will be automatically hashed before storage
> - User stays logged in after password change (token remains valid)
> - Consider adding password strength indicator on UI
> - Show success message and optionally redirect to profile page

### Success Response
**Status Code:** `200 OK`

```json
{
  "success": true,
  "message": "Password changed successfully",
  "data": null
}
```

### Error Responses

#### Incorrect Current Password
**Status Code:** `400 Bad Request`
```json
{
  "success": false,
  "message": "Current password is incorrect"
}
```

#### No Token Provided
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "No token provided"
}
```

#### Invalid Token
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "Invalid token"
}
```

#### User Not Found
**Status Code:** `404 Not Found`
```json
{
  "success": false,
  "message": "User not found"
}
```

---

## 5. Logout User

Logout the authenticated user (client-side token removal).

### Endpoint
```
POST /api/v1/auth/logout
```

### Headers
```json
{
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Authentication
**Required:** Yes (JWT Token)

### Request Body
None

> **Note for Frontend:**
> - This is a **protected route** - requires JWT token
> - This endpoint validates the token but doesn't invalidate it on server
> - **IMPORTANT:** You MUST remove the token from client storage (localStorage/sessionStorage/cookies)
> - Clear all user-related data from your state management
> - Redirect to login page after successful logout
> - Consider adding a logout confirmation dialog

### Success Response
**Status Code:** `200 OK`

```json
{
  "success": true,
  "message": "Logout successful",
  "data": null
}
```

### Error Responses

#### No Token Provided
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "No token provided"
}
```

#### Invalid Token
**Status Code:** `401 Unauthorized`
```json
{
  "success": false,
  "message": "Unauthorized",
  "error": "Invalid token"
}
```

---

## Authentication Flow

### 1. Registration Flow (With Email Verification)
```
Client                          Server
  |                               |
  |-- POST /auth/register ------->|
  |   (name, email, password)     |
  |                               |
  |<---- 201 Created -------------|
  |   (user data, NO TOKEN)       |
  |                               |
  |-- Redirect to verify email -->|
  |                               |
  |-- POST /auth/verify-email --->| (TODO: To be implemented)
  |   (email, otp)                |
  |                               |
  |<---- 200 OK ------------------|
  |   (user, token)               |
  |                               |
  |-- Store token in client ----->|
  |                               |
  |-- Redirect to dashboard ----->|
```

> **Note:** Currently registration returns a token temporarily for testing.
> This will be removed once email verification is implemented.

### 2. Login Flow
```
Client                          Server
  |                               |
  |-- POST /auth/login ---------->|
  |   (email, password)           |
  |                               |
  |<---- 200 OK ------------------|
  |   (user, token)               |
  |                               |
  |-- Store token in client ----->|
```

### 3. Authenticated Request Flow
```
Client                          Server
  |                               |
  |-- GET /auth/me -------------->|
  |   Authorization: Bearer token |
  |                               |
  |                      Verify token
  |                      Get user data
  |                               |
  |<---- 200 OK ------------------|
  |   (user data)                 |
```

---

## Common Error Codes

| Status Code | Description                           |
|-------------|---------------------------------------|
| 200         | OK - Request successful               |
| 201         | Created - Resource created            |
| 400         | Bad Request - Invalid input           |
| 401         | Unauthorized - Invalid/missing token  |
| 404         | Not Found - Resource not found        |
| 409         | Conflict - Resource already exists    |
| 429         | Too Many Requests - Rate limit exceed |
| 500         | Internal Server Error                 |

---

## Token Management

### Storing the Token (Frontend)
After successful login or registration, store the JWT token:

```javascript
// Example: Using localStorage
localStorage.setItem('authToken', data.token);

// Example: Using sessionStorage
sessionStorage.setItem('authToken', data.token);

// Example: Using cookies
document.cookie = `authToken=${data.token}; path=/; secure; httpOnly`;
```

### Including Token in Requests
For protected endpoints, include the token in the Authorization header:

```javascript
// Example: Using fetch
fetch('http://localhost:3000/api/v1/auth/me', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});

// Example: Using axios
axios.get('http://localhost:3000/api/v1/auth/me', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

### Removing Token on Logout
```javascript
// Remove from localStorage
localStorage.removeItem('authToken');

// Remove from sessionStorage
sessionStorage.removeItem('authToken');

// Remove from cookies
document.cookie = 'authToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
```

---

## Postman Collection Setup

### Environment Variables
Create these variables in Postman:

| Variable  | Initial Value                    | Description              |
|-----------|----------------------------------|--------------------------|
| base_url  | http://localhost:3000/api/v1     | API base URL             |
| token     | (leave empty)                    | JWT token (auto-set)     |

### Pre-request Scripts
For protected endpoints, add this to collection pre-request:

```javascript
if (pm.environment.get("token")) {
    pm.request.headers.add({
        key: 'Authorization',
        value: 'Bearer ' + pm.environment.get("token")
    });
}
```

### Test Scripts
For login/register endpoints, add this to save the token:

```javascript
if (pm.response.code === 200 || pm.response.code === 201) {
    var jsonData = pm.response.json();
    if (jsonData.data && jsonData.data.token) {
        pm.environment.set("token", jsonData.data.token);
        console.log("Token saved:", jsonData.data.token);
    }
}
```

---

## Rate Limiting

The API implements rate limiting to prevent abuse:

- **Window:** 15 minutes
- **Max Requests:** Check your environment configuration
- **Response when exceeded:**

```json
{
  "success": false,
  "message": "Too many requests from this IP, please try again later."
}
```

---

## Security Notes

1. **Always use HTTPS in production**
2. **Never expose JWT tokens in URLs**
3. **Store tokens securely (avoid localStorage for sensitive apps)**
4. **Implement token refresh mechanism for better security**
5. **Set appropriate token expiration times**
6. **Validate all input on both client and server side**
7. **Use strong passwords (minimum 8 characters with mixed case, numbers, symbols)**

---

## Testing Checklist

- [ ] Register new user with valid data
- [ ] Register with duplicate email (should fail)
- [ ] Register with invalid role (should fail)
- [ ] Register with password less than 8 characters (should fail)
- [ ] Login with correct credentials
- [ ] Login with incorrect credentials (should fail)
- [ ] Access protected route without token (should fail)
- [ ] Access protected route with invalid token (should fail)
- [ ] Access protected route with expired token (should fail)
- [ ] Get current user with valid token
- [ ] Change password with correct old password
- [ ] Change password with incorrect old password (should fail)
- [ ] Change password with new password less than 8 characters (should fail)
- [ ] Logout successfully

---

## Frontend Integration Guide

### Quick Start Example (React + Axios)

#### 1. Setup Axios Instance
```javascript
// src/api/axios.js
import axios from 'axios';

const API = axios.create({
  baseURL: 'http://localhost:3000/api/v1',
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add token to requests automatically
API.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('authToken');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// Handle 401 errors (token expired/invalid)
API.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default API;
```

#### 2. Auth Service
```javascript
// src/services/authService.js
import API from '../api/axios';

export const authService = {
  // Register new user (No token returned - needs email verification)
  register: async (userData) => {
    const response = await API.post('/auth/register', userData);
    if (response.data.success) {
      // NO TOKEN returned on registration
      // User needs to verify email first
      return response.data.data;
    }
    throw new Error(response.data.message);
  },

  // TODO: Verify email with OTP (will be implemented later)
  // verifyEmail: async (email, otp) => {
  //   const response = await API.post('/auth/verify-email', { email, otp });
  //   if (response.data.success) {
  //     localStorage.setItem('authToken', response.data.data.token);
  //     return response.data.data;
  //   }
  //   throw new Error(response.data.message);
  // },

  // Login user (Returns token)
  login: async (email, password) => {
    const response = await API.post('/auth/login', { email, password });
    if (response.data.success) {
      localStorage.setItem('authToken', response.data.data.token);
      return response.data.data;
    }
    throw new Error(response.data.message);
  },

  // Get current user
  getCurrentUser: async () => {
    const response = await API.get('/auth/me');
    return response.data.data;
  },

  // Change password
  changePassword: async (oldPassword, newPassword) => {
    const response = await API.post('/auth/change-password', {
      oldPassword,
      newPassword,
    });
    return response.data;
  },

  // Logout
  logout: async () => {
    await API.post('/auth/logout');
    localStorage.removeItem('authToken');
  },
};
```

#### 3. Usage in Components
```javascript
// Register Component
import { authService } from '../services/authService';

const Register = () => {
  const handleRegister = async (e) => {
    e.preventDefault();
    try {
      const result = await authService.register({
        name: 'John Doe',
        email: 'john@example.com',
        password: 'SecurePass123',
        role: 'SME_USER', // Optional: defaults to SME_USER
      });
      console.log('User registered:', result.user);

      // NO TOKEN received - redirect to email verification page
      // Pass email to verification page (TODO: implement verification)
      navigate('/verify-email', { state: { email: result.user.email } });

      // Show success message
      toast.success('Registration successful! Please check your email for verification code.');
    } catch (error) {
      console.error('Registration failed:', error.message);
    }
  };
};

// TODO: Email Verification Component (to be implemented)
// const VerifyEmail = () => {
//   const handleVerifyOTP = async (e) => {
//     e.preventDefault();
//     try {
//       const result = await authService.verifyEmail(email, otp);
//       // Token received after verification
//       console.log('Email verified:', result.user);
//       navigate('/dashboard');
//     } catch (error) {
//       console.error('Verification failed:', error.message);
//     }
//   };
// };

// Login Component
const Login = () => {
  const handleLogin = async (e) => {
    e.preventDefault();
    try {
      const result = await authService.login(email, password);
      console.log('User logged in:', result.user);
      navigate('/dashboard');
    } catch (error) {
      console.error('Login failed:', error.message);
    }
  };
};
```

### Important Implementation Notes

#### Role-Based Access Control
```javascript
// Check user role before rendering admin features
const user = await authService.getCurrentUser();

if (user.role === 'ADMIN') {
  // Show admin features
} else if (user.role === 'AUDIT_PARTNER') {
  // Show audit partner features
} else if (user.role === 'SME_USER') {
  // Show SME user features
} else if (user.role === 'VIEWER') {
  // Show read-only features
}
```

#### Token Expiration Handling
```javascript
// Check if token is expired before making requests
import jwt_decode from 'jwt-decode';

const isTokenExpired = (token) => {
  try {
    const decoded = jwt_decode(token);
    return decoded.exp * 1000 < Date.now();
  } catch (error) {
    return true;
  }
};

// Use in your app initialization
const token = localStorage.getItem('authToken');
if (token && isTokenExpired(token)) {
  localStorage.removeItem('authToken');
  // Redirect to login
}
```

#### Password Validation (Client-Side)
```javascript
const validatePassword = (password) => {
  if (password.length < 8) {
    return 'Password must be at least 8 characters';
  }
  // Add more validation as needed
  return null;
};
```

### Common Pitfalls to Avoid

1. **Don't send the token in URL parameters** - Always use Authorization header
2. **Don't store sensitive data in localStorage on shared computers** - Consider sessionStorage
3. **Always validate on both client and server** - Client validation is for UX only
4. **Handle network errors gracefully** - Show user-friendly error messages
5. **Clear all user data on logout** - Token, user state, cached data, etc.
6. **Use HTTPS in production** - Never send passwords over HTTP
7. **Implement proper error handling** - Check for `success: false` in responses

---

## Support

For issues or questions, please contact the backend team or create an issue in the project repository.

---

**Last Updated:** October 24, 2025
**API Version:** 1.0
**Documentation Version:** 1.1
